<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon.png" />
    <title>Ela - 云辰自動化測試系統</title>

    <link href="/templates/css/lib/chartist/chartist.min.css" rel="stylesheet" />
    <link href="/templates/css/lib/owl.carousel.min.css" rel="stylesheet" />
    <link href="/templates/css/lib/owl.theme.default.min.css" rel="stylesheet" />
    <!-- Bootstrap Core CSS -->
    <link href="/templates/css/lib/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <link href="/templates/css/helper.css" rel="stylesheet" />
    <link href="/templates/css/style.css" rel="stylesheet" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:** -->
    <!--[if lt IE 9]>
      <script src="https:**oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https:**oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <style>
.dropdown-menu {
    display: none; /* Hide the dropdown menu initially */
}

.close {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    cursor: pointer;
}

.spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8); 
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000; 
    }
.disabled {
    pointer-events: none;
    opacity: 0.5;
}
  </style>
  <body class="fix-header fix-sidebar">
    <!-- Preloader - style you can find in spinners.css -->
    <div class="preloader">
      <svg class="circular" viewBox="25 25 50 50">
        <circle
          class="path"
          cx="50"
          cy="50"
          r="20"
          fill="none"
          stroke-width="2"
          stroke-miterlimit="10"
        />
      </svg>
    </div>
    <!-- Main wrapper  -->
    <div id="main-wrapper">
      <!-- header header  -->
      <div class="header">
        <nav class="navbar top-navbar navbar-expand-md navbar-light">
          <!-- Logo -->
          <div class="navbar-header">
            <a class="navbar-brand" href="/templates/index.html">
              <!-- Logo icon -->
              <b
                ><img src="/templates/images/logo.png" alt="homepage" class="dark-logo"
              /></b>
              <!--End Logo icon -->
              <!-- Logo text -->
              <span
                ><img
                  src="/templates/images/logo-text.png"
                  alt="homepage"
                  class="dark-logo"
              /></span>
            </a>
          </div>
          <!-- End Logo -->
          <div class="navbar-collapse">
            <!-- toggle and nav items -->
            <ul class="navbar-nav mr-auto mt-md-0">
              <!-- This is  -->
              <li class="nav-item">
                <a
                  class="nav-link nav-toggler hidden-md-up text-muted"
                  href="javascript:void(0)"
                  ><i class="mdi mdi-menu"></i
                ></a>
              </li>
              <li class="nav-item m-l-10">
                <a
                  class="nav-link sidebartoggler hidden-sm-down text-muted"
                  href="javascript:void(0)"
                  ><i class="ti-menu"></i
                ></a>
              </li>
            </ul>
            <!-- User profile and search -->
            <ul class="navbar-nav my-lg-0">
              <!-- Search -->
              <li class="nav-item hidden-sm-down search-box">
                <a
                  class="nav-link hidden-sm-down text-muted"
                  href="javascript:void(0)"
                  ><i class="ti-search"></i
                ></a>
                <form class="app-search">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Search here"
                  />
                  <a class="srh-btn"><i class="ti-close"></i></a>
                </form>
              </li>
              <!-- Profile -->
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle text-muted"
                  ><img src="/templates/images/users/5.jpg" alt="user" class="profile-pic"
                /></a>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <!-- End header header -->
      <!-- Left Sidebar  -->
      <div class="left-sidebar">
        <!-- Sidebar scroll-->
        <div class="scroll-sidebar">
          <!-- Sidebar navigation-->
          <nav class="sidebar-nav">
            <ul id="sidebarnav">
              <li class="nav-devider"></li>
              <li class="nav-label">Home</li>
              <li>
                <a class="has-arrow" href="#" aria-expanded="false"
                  ><i class="fa fa-tachometer"></i
                  ><span class="hide-menu">儀表板 </span></a
                >
                <ul aria-expanded="false" class="collapse">
                  <li><a href="/templates/index.html">所有裝置</a></li>
                </ul>
              </li>
              <li class="nav-label">Apps</li>
              <li>
                <a class="has-arrow" href="#" aria-expanded="false"
                  ><i class="fa fa-envelope"></i
                  ><span class="hide-menu">設備測試</span></a
                >
                <ul aria-expanded="false" class="collapse">
                  <li><a href="/templates/email-compose.html">設備控制</a></li>
                </ul>
              </li>
              <li>
                <a class="has-arrow" href="#" aria-expanded="false"
                  ><i class="fa fa-bar-chart"></i
                  ><span class="hide-menu">法規自動化</span></a
                >
                <ul aria-expanded="false" class="collapse">
                  <li><a href="/templates/chart-flot.html">IEC63180-2020</a></li>
                  <li><a href="/templates/chart-morris.html">NEMA WD7-2011</a></li>
                  <li><a href="/templates/chart-chartjs.html">EN50131-2-2-2017</a></li>
                  <li><a href="/templates/chart-chartist.html">EN50131-2-4-2020</a></li>
                </ul>
              </li>
            </ul>
          </nav>
          <!-- End Sidebar navigation -->
        </div>
        <!-- End Sidebar scroll-->
      </div>
      <!-- End Left Sidebar  -->
      <!-- Page wrapper  -->
      <div class="page-wrapper">
        <!-- Bread crumb -->
        <div class="row page-titles">
          <div class="col-md-5 align-self-center">
            <h3 class="text-primary">儀表板/所有裝置</h3>
          </div>
          <div class="col-md-7 align-self-center">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="javascript:void(0)">APPS</a>
              </li>
              <li class="breadcrumb-item active">設備控制</li>
            </ol>
          </div>
        </div>


        <li class="nav-item dropdown mega-dropdown">
          <a
            class="nav-link dropdown-toggle text-muted"
            href="#"
            data-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
            ><i class="fa fa-th-large">log</i></a
          >
          <div class="dropdown-menu animated zoomIn">
            <div class="dropdown-menu-header">

              <span id="closePopup" class="close">&times;</span>

            </div>
            <ul class="mega-dropdown-menu row">
              <li class="col-lg-3 m-b-30">
                <h4 class="m-b-20">操作日誌</h4>
                <!-- Contact -->
                <div id="log">
                  <p>時間 裝置 指令 狀態 操作者</p>
                </div>
                <div class="button-container">
                  <button onclick="downloadLog()">下載記錄</button>
                  <button onclick="clearLog()">清除</button>
              </div>
              </li>
            </ul>
          </div>
        </li>
        <div id="spinner-overlay" class="spinner-overlay" style="display: none;">
          <div class="spinner"></div>
      </div>
        <!-- End Bread crumb -->
        <h2>所有狀態</h2>
        <!-- Container fluid  -->
        <div class="container-fluid">
          <!-- Start Page Content -->
          <div class="row">
            <div class="col-md-3">
              <div class="card p-30">
                <h2>SB馬達</h2>
                  <div class="input-states">
                    <form onsubmit="sendData(event)">
                      <div class="form-group row">
                        <label for="track" class="col-sm-6 control-label">track</label>
                        <div class="col-sm-6">
                          <select id="track" name="track" class="form-control" style="text-align: center;">
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                          </select>
                        </div>
                      </div>


                    <div class="form-group row">
                      <label for="track_number" class="col-sm-6 control-label"
                        >track_number</label
                      >
                      <div class="col-sm-6">
                        <input type="text" id="track_number" name="track_number" min="0"  required class="form-control"  style="text-align: right;"/>
                      </div>
                    </div>

                    <div class="form-group row">
                      <label for="direction" class="col-sm-6 control-label">direction</label>
                      <div class="col-sm-6">
                        <select id="direction" name="direction" class="form-control" style="text-align: center;">
                          <option value="forward">forward</option>
                          <option value="backforward">backforward</option>
                        </select>
                      </div>
                    </div>


                    <button type="submit">送出</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="container-fluid">
          <!-- Start Page Content -->
          <div class="row">

            <div class="col-md-3">
              <div class="card p-30">
                <h2>SB馬達</h2>
                <div class="input-states">
                  <form class="form-horizontal">
                    <div class="row">
                      <label for="received-track" class="col-sm-3 control-label"
                        >track</label
                      > 
                      <div class="col-sm-9">
                        <input type="text" id="received-track" readonly/>
                      </div>
                    </div>

                    <div class="row">
                      <label for="received-track" class="col-sm-3 control-label"
                        >track_number</label
                      > 
                      <div class="col-sm-9">
                        <input type="number" id="received-track_number" readonly/>
                      </div>
                    </div>

                    <div class="row">
                      <label for="received-direction" class="col-sm-3 control-label"
                        >direction</label
                      > 
                      <div class="col-sm-9">
                        <input type="text" id="received-direction" readonly/>
                      </div>
                    </div>


                    <div class="row">
                      <label for="received-sb_time" class="col-sm-3 control-label"
                        >更新時間</label
                      >
                      <div class="col-sm-9">
                        <input type="text" id="received-sb_time" readonly><br>
                      </div>
                    </div>
                    <div class="row">
                      <label for="received-sb_ip" class="col-sm-3 control-label"
                        >IP 位置:</label
                      >
                      <div class="col-sm-9">
                        <input type="text" id="received-sb_ip" readonly><br>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          <!-- End PAge Content -->
        </div>
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-3">
              <div class="card p-30">
                <div class="input-states">
                  <div class="row">
                    <label for="received-sb_name" class="col-sm-3 control-label">sb name:</label>
                    <div class="col-sm-9">
                      <input type="text" id="received-sb_name" readonly><br>
                    </div>
                  </div>
                  <div class="row">
                    <label for="received-sb_status" class="col-sm-3 control-label">sb status:</label>
                    <div class="col-sm-9">
                      <input type="text" id="received-sb_status" readonly><br>
                    </div>
                  </div>

                  <button id="selfCheckButton">Send Request</button>
              </div>
             </div>
            </div>
           </div>
          </div>

          <button onclick="fetchData('turn_on_off_remote')">Turn On/Off Remote</button>
          <button onclick="fetchData('velocity_adjust')">Velocity Adjust</button>
          <button onclick="fetchData('battery_turn_on_off')">Battery Turn On/Off</button>
          <button onclick="fetchData('remote_battery_comm_check')">Remote Battery Comm Check</button>
          <button onclick="fetchData('battery_status_check')">Battery Status Check</button>
          <button onclick="fetchData('remote_direction_check')">Remote Direction Check</button>
          <button onclick="fetchData('remote_power_check')">Remote Power Check</button>
          <button onclick="fetchData('check_velocity_status')">Check Velocity Status</button>
          <button onclick="fetchData('control_turn_on_off_remote')">Control Turn On/Off Remote</button>
          <button onclick="fetchData('control_velocity_adjust')">Control Velocity Adjust</button>
          <button onclick="fetchData('control_battery_turn_on_off')">Control Battery Turn On/Off</button>
          <button onclick="fetchData('control_moving_direction_switch')">Control Moving Direction Switch</button>

          <div id="output">Response will appear here...</div>
        <!-- End Container fluid  -->
        <!-- footer -->
        <!-- End footer -->
      </div>
      <!-- End Page wrapper  -->
    </div>
    <!-- End Wrapper -->
    <!-- All Jquery -->
    <script src="/templates/js/lib/jquery/jquery.min.js"></script>
    <!-- Bootstrap tether Core JavaScript -->
    <script src="/templates/js/lib/bootstrap/js/popper.min.js"></script>
    <script src="/templates/js/lib/bootstrap/js/bootstrap.min.js"></script>
    <!-- slimscrollbar scrollbar JavaScript -->
    <script src="/templates/js/jquery.slimscroll.js"></script>
    <!--Menu sidebar -->
    <script src="/templates/js/sidebarmenu.js"></script>
    <!--stickey kit -->
    <script src="/templates/js/lib/sticky-kit-master/dist/sticky-kit.min.js"></script>
    <script>
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="/templates/js/lib/datamap/d3.min.js"></script>
    <script src="/templates/js/lib/datamap/topojson.js"></script>
    <script src="/templates/js/lib/datamap/datamaps.world.min.js"></script>
    <script src="/templates/js/lib/datamap/datamap-init.js"></script>

    <script src="/templates/js/lib/weather/jquery.simpleWeather.min.js"></script>
    <script src="/templates/js/lib/weather/weather-init.js"></script>
    <script src="/templates/js/lib/owl-carousel/owl.carousel.min.js"></script>
    <script src="/templates/js/lib/owl-carousel/owl.carousel-init.js"></script>

    <script src="/templates/js/lib/chartist/chartist.min.js"></script>
    <script src="/templates/js/lib/chartist/chartist-plugin-tooltip.min.js"></script>
    <script src="/templates/js/lib/chartist/chartist-init.js"></script>
    <!--Custom JavaScript -->
    <script src="/templates/js/custom.min.js"></script>
    <script>



            function fetchData(apiId) {
              console.log(apiId)
              fetch(`/execute_api?api_id=${apiId}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('output').textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                document.getElementById('output').textContent = 'Error: ' + error;
            });
        }
       
    document.getElementById('selfCheckButton').addEventListener('click', (event) => {
    event.preventDefault();
    fetch('/self_check', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('received-sb_name').value = data.name;
        document.getElementById('received-sb_status').value = data.self_check_status;
    })
    .catch(error => console.error('Error:', error));
});


        function sendData(event) {
            event.preventDefault();
            var spinnerOverlay = document.getElementById("spinner-overlay");
            var buttons = document.querySelectorAll("button");

        spinnerOverlay.style.display = "flex";
        buttons.forEach((button) => button.classList.add("disabled"));
            const data = { track: document.getElementById('track').value,
                           track_number: parseFloat(document.getElementById('track_number').value),
                           direction: document.getElementById('direction').value
             };

            fetch('/api/sb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
            document.getElementById('received-track').value = data.location.track;
            document.getElementById('received-track_number').value = data.location.track_number;
            document.getElementById('received-direction').value = data.location.direction;
            document.getElementById('received-sb_time').value = data.sb_time;
            document.getElementById('received-sb_ip').value = data.sb_ip;
            logGenerate(data.logs);
            setTimeout(function () {
              spinnerOverlay.style.display = "none";
              buttons.forEach((button) => button.classList.remove("disabled"));
            }); 
        });
        }
      

      var logEntries = [];

      function logGenerate(logs) {
        var logDiv = document.getElementById("log");
        var newLogEntry = document.createElement("p");
        var logText = logs['time'] + '   '+ logs['device'] +'   '+logs['command'] +'  '+logs['status'] + '  ' + logs['operator']  ;
        newLogEntry.textContent = logText;
        logDiv.appendChild(newLogEntry);
        logEntries.push(logs);
      }

        function downloadLog() {
        var worksheet = XLSX.utils.json_to_sheet(logEntries);
        var workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Log");

        XLSX.writeFile(workbook, "log.xlsx");
      }

      function clearLog() {
        var logDiv = document.getElementById("log");
        logDiv.innerHTML = "<p>時間  裝置  指令  狀態  操作者</p>";
        logEntries = [];
      }


      document.addEventListener('DOMContentLoaded', function() {
    var dropdownToggle = document.querySelector('.nav-link.dropdown-toggle');
    var dropdownMenu = document.querySelector('.dropdown-menu');
    var closePopupButton = document.getElementById('closePopup');

    // Show the dropdown menu when the button is clicked
    dropdownToggle.addEventListener('click', function() {
        dropdownMenu.classList.toggle('show');
    });

    // Close the dropdown menu when the "X" button is clicked
    closePopupButton.addEventListener('click', function() {
        dropdownMenu.classList.remove('show');
        // Simulate clicking the dropdown toggle button
        dropdownToggle.click();
    });
});


    </script>
  </body>
</html>
